// PORTING: Hook basic block in bt_spi_send just before calling net_buf_unref
const HOOKED_ADDR = 0x8006a44;

pub fn main(api) {
    // CVE check
    api.on_basic_block(Some(HOOKED_ADDR), on_CVE);
}

fn on_CVE(pc) {
    // PORTING: Ensure return result variable register assignment
    let driver_fn_err = register::read("R4")?;

    // The bug occurs in case net_buf_unref is called despite an error being returned
    if driver_fn_err != 0 {
        input::add_bug("new-Bug-CVE-2022-3806");
    }
}
