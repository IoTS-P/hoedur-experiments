pub fn main(api) {
    // CVE check
    // PORTING: hook bbs leading to call to net_buf_simple_tailroom in net_6lo_uncompress
    api.on_basic_block(Some(symbolizer::resolve("net_6lo_uncompress")? + 0x3e), |_| on_CVE_2021_3323_callsite_1());
    api.on_basic_block(Some(symbolizer::resolve("net_6lo_uncompress")? + 0x46), |_| on_CVE_2021_3323_callsite_2());
}

fn check_compressed_hdr_size(compressed_hdr_size) {
    let net_buf = register::read("R6")?;
    let pkt_buf_len_addr = (net_buf + 0x8) + 0x4;
    let pkt_buf_len = memory::read_u16(pkt_buf_len_addr)?;

    if pkt_buf_len < compressed_hdr_size {
        input::add_bug("CVE-2021-3323");
    }
}

fn on_CVE_2021_3323_callsite_1() {
    let compressed_hdr_size = register::read("R3")?;

    check_compressed_hdr_size(compressed_hdr_size);
}

fn on_CVE_2021_3323_callsite_2() {
    let compressed_hdr_size = register::read("R4")?;

    check_compressed_hdr_size(compressed_hdr_size);
}