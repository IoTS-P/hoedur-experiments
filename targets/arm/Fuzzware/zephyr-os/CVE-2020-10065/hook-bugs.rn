const ADD_MEM_CALL_LOC_spi_rx_thread = 0x8001355;

pub fn main(api) {
    // CVE check
    api.on_basic_block(Some(symbolizer::resolve("net_buf_simple_add_mem")?), |_| on_CVE_2020_10065());
}

fn on_CVE_2020_10065() {
    // Check for buf size OOB in calls to net_buf_simple_add_mem
    let buf = register::read("R0")?;
    let len = register::read("R2")?;
    let buf_len = memory::read_u16(buf + 4)?;
    let buf_size = memory::read_u16(buf + 6)?;

    if buf_len + len > buf_size {
        if register::read("LR")? == ADD_MEM_CALL_LOC_spi_rx_thread {
            input::add_bug("CVE-2020-10065");
        } else {
            input::add_bug("GENERIC-len-overflow");
        }
    }
}