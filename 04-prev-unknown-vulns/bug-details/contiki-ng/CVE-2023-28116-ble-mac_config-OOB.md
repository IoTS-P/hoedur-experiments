# Buffer Overflows when using `MAC_BLE`

## Summary

The `MAC_BLE` implementation does not consider the actual `packetbuf`-size leading to multiple out-of-bounds writes.

## Proposed Advisory Text

Contiki-NG uses an global buffer `packetbuf` for processing of packets, with the size of `PACKETBUF_SIZE`.

However, when enabling `MAC_BLE`, the implementation assumes `packetbuf` is large enough for fragmented packets. With the default configuration this can lead to out-of-bounds writes when larger than `PACKETBUF_SIZE` packets are processed. This can result in a denial of service or possibly a remote code execution.

## Description

When enabling `MAC_BLE` there are multiple uses of `packetbuf` without bounds checks.

`packetbuf` is a pointer to the 32-bit aligned `packetbuf_aligned` with a size of 128 bytes:

```c
/* The declarations below ensure that the packet buffer is aligned on
   an even 32-bit boundary. On some platforms (most notably the
   msp430 or OpenRISC), having a potentially misaligned packet buffer may lead to
   problems when accessing words. */
static uint32_t packetbuf_aligned[(PACKETBUF_SIZE + 3) / 4];
static uint8_t *packetbuf = (uint8_t *)packetbuf_aligned;
```

https://github.com/contiki-ng/contiki-ng/blob/d544f2ec1e0b9bf37229fe8e8ac846f794efa70d/os/net/packetbuf.c#L58-L63

```c
#define PACKETBUF_SIZE 128
```

https://github.com/contiki-ng/contiki-ng/blob/d544f2ec1e0b9bf37229fe8e8ac846f794efa70d/os/net/packetbuf.h#L61-L68

`NETSTACK_MAC.max_payload` of `MAC_BLE` is defined as `1280` here:

```c
static int
max_payload(void)
{
  return BLE_L2CAP_NODE_MTU;
}
```

[https://github.com/contiki-ng/contiki-ng/blob/5098879fda00f9df022e78c70ae5edc95bfb7b01/os/net/mac/ble/ble-l2cap.c#L533-L537](https://github.com/contiki-ng/contiki-ng/blob/5098879fda00f9df022e78c70ae5edc95bfb7b01/os/net/mac/ble/ble-l2cap.c#L533-L537)

```c
#define BLE_L2CAP_NODE_MTU              1280
```

https://github.com/contiki-ng/contiki-ng/blob/5098879fda00f9df022e78c70ae5edc95bfb7b01/os/net/mac/ble/ble-l2cap.h#L72-L77

The larger size of `1280`-bytes which allows out-of-bounds writes of up to `1152`-bytes is then used in different places:

- In the [`CHECK_BUFFER_SPACE`](https://github.com/contiki-ng/contiki-ng/blob/d544f2ec1e0b9bf37229fe8e8ac846f794efa70d/os/net/ipv6/sicslowpan.c#L706-L712) implementation in `sicslowpan`
  - due to [`PACKETBUF_PAYLOAD_END`](https://github.com/contiki-ng/contiki-ng/blob/d544f2ec1e0b9bf37229fe8e8ac846f794efa70d/os/net/ipv6/sicslowpan.c#L100) using [`mac_max_payload = NETSTACK_MAC.max_payload();`](https://github.com/contiki-ng/contiki-ng/blob/d544f2ec1e0b9bf37229fe8e8ac846f794efa70d/os/net/ipv6/sicslowpan.c#L1671)
- In the [fragmentation needed check](https://github.com/contiki-ng/contiki-ng/blob/d544f2ec1e0b9bf37229fe8e8ac846f794efa70d/os/net/ipv6/sicslowpan.c#L1704) in `sicslowpan`:
  - leading to an [OOB-write](https://github.com/contiki-ng/contiki-ng/blob/d544f2ec1e0b9bf37229fe8e8ac846f794efa70d/os/net/ipv6/sicslowpan.c#L1837-L1838) due to missing fragmentation
- Probably many more places

## Impact

- The attack can likely get remote code execution due to control over content and length of some out-of-bounds writes.
- Denial of service

## Proposed Fix

- Assert `BLE_L2CAP_NODE_MTU` fits in `packetbuf`.
- Refactor `MAC_BLE` implementation and add bounds checks.
